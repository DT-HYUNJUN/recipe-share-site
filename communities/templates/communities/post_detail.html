{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load tailwind_filters %}
{% load static %}

{% block content %}
<div class="container mx-auto max-w-screen-xl my-10">
  <!-- 본문 -->
  <div class="border p-3 rounded-lg grid grid-cols-12">
    <div class="col-span-1 px-5 mt-2">
      <img class="w-4/5 rounded-full" {% if post.user.profile_image %} src="{{ post.user.profile_image.url }}" {% else %} src="{% static 'img/profile_image2.png' %}" {% endif %}  alt="">
    </div>
    <div class="col-span-11">
      <div class="flex justify-between gap-3 text-sm my-3">
        <div class="flex gap-3 text-sm my-3 items-center">
          {% comment %} <p>{{ post.user.nickname }}</p>|<p class="text-gray-600">{{ post.created_at }}</p> {% endcomment %}
          <a class="flex" href="{% url 'accounts:profile' post.user  %}"> <p class=" text-base hover:text-blue-800 hover:underline">{{ post.user.nickname }}</p></a>
          |<p class="text-gray-600">{{ post.created_at }}</p>
        </div>

        {% if request.user == post.user %}
          <button id="dropdownMenuIconButton" data-dropdown-toggle="dropdownDots" class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-600" type="button"> 
            <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
          </button>
        {% endif %}
        <!-- Dropdown menu -->
        <div id="dropdownDots" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-36 dark:bg-gray-700 dark:divide-gray-600">
          <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
            <li>
              <a class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" href="{% url 'communities:update' post.pk %}">수정하기</a>
            </li>
            <li>
              <a class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" href="{% url 'communities:delete' post.pk %}">삭제하기</a>
            </li>
          </ul>
        </div>
      </div>
      <h1 class=" text-xl my-4 text-[#2E8B57]" >  {{ post.title }}</h1>
      <p class="text-md p-3">{{ post.content|linebreaksbr }}</p>
      <div>
        <img class="w-4/5" {% if post.image %} src="{{ post.image.url }}" {% endif %}  alt="">
      </div>
      <form class="like-form mt-10" data-post-id="{{post.pk}}" >
        {% csrf_token %}
        {% if request.user in post.like_posts.all %}
          <button title="{{post.like_posts.all|length}}" type="submit" value="좋아요 취소" id="like-{{post.pk}}">
            <i class="bi bi-heart-fill" id="like-heart"></i>
          </button>
        {% else %}
          <button title="{{post.like_posts.all|length}}" type="submit" svalue="좋아요" id="like-{{post.pk}}">
            <i class="bi bi-heart" id="like-heart"></i>
          </button>
        {% endif %}
        <span id="post-like-count">{{ post.like_posts.all|length }}</span>
      </form>
    </div>
  </div>
  {% comment %} action="{% url 'communities:comment_create' post.pk %}" method="POST" {% endcomment %}
  {% if request.user.is_authenticated %}
    <form id="review-form" class="mt-5" data-pk="{{ post.pk }}" data-csrftoken="{{ csrf_token }}" data-url="{% url 'communities:comment_create' post.pk %}">
      {% csrf_token %}
      <div class="border rounded-lg p-5 pb-0">
        <p class="font-bold ms-4">{{ request.user.nickname }}</p>
        {{ comment_form.content|as_crispy_field }}
        <div class="flex justify-end">
          <button type="submit" id="review_create_submit" class="text-white bg-[#2e8b57] hover:bg-[#3CB371] focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-2.5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">작성</button>
        </div>
      </div>
    </form>
  {% endif %}

  <section id="reviews">
    <p class="text-xl font-bold mt-3 mb-5 border-b border-b-[#2e8b57]">댓글 <span id="review-count">{{ comments.count }}</span></p>
    {% for comment in comments %}
    <div id="review" {% if request.user == comment.user %} class="grid grid-cols-12 text-sm gap-3 py-5 px-3 bg-[#9ACD32]/[0.2] border-b" {% else %} class="grid grid-cols-12 text-sm my-5 px-3 border-b" {% endif %} data-csrftoken="{{ csrf_token }}" data-recipe-pk="{{ comment.pk }}" data-review-pk="{{ comment.pk }}"  data-update-url="{% url 'communities:comment_update' post.pk comment.pk %}" data-delete-url="{% url 'communities:comment_delete' post.pk comment.pk %}">
      <!-- 리뷰 작성자 프로필 사진 -->
      <div class="col-span-1 flex items-start mb-1">
        <img class="w-10 rounded-full" {% if comment.user.profile_image %} src="{{ comment.user.profile_image.url }}" {% else %} src="{% static 'img/profile_image2.png' %}"{% endif %} alt="profile">
      </div>
      <!-- 작성자 / 내용 -->
      <div class="col-span-11">
        <div class="flex justify-between">
          {% comment %} <p class="font-bold mb-1">{{ comment.user.nickname }}</p> {% endcomment %}
          <a class=" hover:text-blue-800 hover:underline" href="{% url 'accounts:profile' comment.user %}"> <p class="font-bold mb-1">{{ comment.user.nickname }}</p></a>
          {% if request.user == comment.user %}
          <div>
            <button id="dropdownDefaultButton" data-dropdown-toggle="dropdown-{{ comment.pk }}" type="button"><i class="bi bi-three-dots-vertical"></i></button>
            <div id="dropdown-{{ comment.pk }}" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-20 dark:bg-gray-700">
              <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
                <li>
                  <a id="edit-btn" class="block m-0 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white cursor-pointer">수정</a>
                </li>
                <li>
                  <a id="delete-btn" class="block m-0 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white cursor-pointer">삭제</a>
                </li>
              </ul>
            </div>
          </div>
          {% endif %}
        </div>
        <div id="review" class="mb-2" data-csrftoken="{{ csrf_token }}" data-recipe-pk="{{ recipe.pk }}" data-review-pk="{{ review.pk }}"  data-update-url="{% url 'recipes:review_update' %}">
          <p id="review-content" class="col-span-6 flex items-center">{{ comment.content|linebreaksbr }}</p>
          <div id="comment-textarea" class="hidden col-span-6 w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
            <div class="px-4 py-2 bg-white rounded-t-lg dark:bg-gray-800">
              <label for="comment" class="sr-only">Your comment</label>
              <textarea id="review-update-field" rows="4" class="w-full px-0 text-sm text-gray-900 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400">{{ comment.content|linebreaksbr }}</textarea>
            </div>
            <div class="flex items-cente gap-3 px-3 py-2 border-t dark:border-gray-600">
              <button id="submit-btn" type="submit" class="inline-flex items-center py-2.5 px-4 text-xs font-medium text-center text-white bg-[#2E8B57] rounded-lg focus:ring-4 focus:ring-blue-200 dark:focus:ring-blue-900 hover:bg-[#3CB371]">
                  수정
              </button>
              <button id="cancel-btn" class="text-gray-500">취소</button>
            </div>
          </div>
          <!-- 댓글 작성 날 -->
        </div>
        <span class="text-gray-500">{{ comment.created_at|date:'Y-m-d H:i' }}</span>
      </div>
    </div>
    {% endfor %}
  </section>
</div>
{% endblock content %}


{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{% static 'js/communities/review.js' %}"></script>

<!--좋아요 비동기-->
<script>
  const forms = document.querySelectorAll('.like-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  forms.forEach((form) => {
    form.addEventListener('submit', function(event) {
      event.preventDefault()

      const postId = event.target.dataset.postId
      axios({
        method : 'post',
        url: `http://127.0.0.1:8000/communities/${postId}/like/`,
        headers : {'X-CSRFToken': csrftoken},
      })

      .then((response) => {
        const like = response.data.like
        const likeBtn = document.querySelector(`#like-${postId}`)
        const likeBtni = document.querySelector('#like-heart')
        const postLikeCount = form.querySelector('#post-like-count')
        if (like === true) {
          postLikeCount.textContent = parseInt(postLikeCount.textContent) + 1
          likeBtni.classList.remove('bi-heart')
          likeBtni.classList.add('bi-heart-fill') 
        } else {
          postLikeCount.textContent = parseInt(postLikeCount.textContent) - 1
          likeBtni.classList.remove('bi-heart-fill')
          likeBtni.classList.add('bi-heart')  
        }
      })

      .catch((error) => {
        console.log(error.response)
      })
    })
  })
</script>

<!--댓글 입력 비동기-->
{% comment %} <script>
  const form = document.querySelector('#comment-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  form.addEventListener('submit', function(event) {
    event.preventDefault()

    const postId = event.target.dataset.postId
    axios({
      method : 'post',
      url :  `communities/${postId}/create`,
      headers : {'X-CSRFToken': csrftoken2,}
    })
  })
</script> {% endcomment %}

{% comment %} <script>
  const commentSection = document.querySelector('#comments')
  const comments = document.querySelectorAll('#comment')

  const commentForm = document.querySelector('#comment-form')
  const commentField = document.querySelector('#id_content')
  commentField.setAttribute('rows', '2')
  commentField.setAttribute('placeholder', '여기에 댓글을 작성해보세요!')
  commentField.classList.add ('border-0')
  commentField.classList.add ('focus:ring-0')
  commentField.classList.add ('resize-none')

  const commentSubmit = commentForm.querySelector('#rcomment_create_submit')
  commentSubmit.addEventListener('click', (e) => {
    e.preventDefault()
    let param = {
      'pk': commentForm.dataset.pk,
      'content': reviewField.value
    }
    $.ajax({
      url: reviewForm.dataset.url,
      type: 'POST',
      headers: {
        'X-CSRFTOKEN': reviewForm.dataset.csrftoken
      },
      data: JSON.stringify(param),
      success:function(data) {
      },
      error: function() {
        alert('오류!')
      }
    })
  })



    form.addEventListener('submit', function(event) {
      event.preventDefault()

      const postId = event.target.dataset.postId
      axios({
        method: 'post',
        url: `http://127.0.0.1:8000/communities/${postId}/create/`,
        headers: {'X-CSRFToken': csrftoken}
      })
      .then((response) => {
        const successUrl = response.data.success_url
        window.location.href = successUrl
      })
      .catch((error) => {
        console.log(error.response)
      })
    })
</script> {% endcomment %}
{% endblock script %}