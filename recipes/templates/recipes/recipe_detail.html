{% extends 'base.html' %}

{% load tailwind_filters %}
{% load static %}

{% block content %}
<div class="container mx-auto max-w-screen-xl">
  <section class="px-52">
    <!-- 레시피 정보 -->
    <div class="flex-col space-y-4">
      <!-- 사진 -->
      <div class="mb-4">
        {% if recipe.image %}
          <img src="{{ recipe.image.url }}" alt="">
        {% endif %}
      </div>
      <!-- 제목, 북마크-->
      <div class="flex justify-between">
        <h1 class="text-2xl font-bold">{{ recipe.title }}</h1>
        <button class="text-2xl"><i class="bi bi-bookmark-plus"></i></button>
      </div>
      <!-- 난이도, 소요시간-->
      <div class="flex items-center gap-10">
        <div class="flex items-center gap-2">
          <span>난이도</span>
          <img src="{% static 'img/rating-star.svg' %}" alt="">
        </div>
        <div class="flex items-center gap-2">
          <div class="text-xs">
            <img src="{% static 'img/coocking-time.png' %}" alt="">
          </div>
          <span class="">{{ recipe.time }}</span>
        </div>
      </div>
      <hr>
      <h1 class="text-gray-600">{{ recipe.content }}</h1>
    </div>

    <!-- 재료 -->
    <div>
      <p class="text-xl font-bold mt-3 border-b border-b-[#2e8b57]">재료</p>
      <div class="mt-3">

        <div class="relative overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
              <tr>
                <th scope="col" class="px-6 py-3">
                  재료
                </th>
                <th scope="col" class="px-6 py-3 text-end">
                  수량
                </th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                  Apple MacBook Pro 17"
                </th>
                <td class="px-6 py-4 text-end">
                  Silver
                </td>
              </tr>
              <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                  Microsoft Surface Pro
                </th>
                <td class="px-6 py-4 text-end">
                  White
                </td>
              </tr>
              <tr class="bg-white dark:bg-gray-800">
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                  Magic Mouse 2
                </th>
                <td class="px-6 py-4 text-end">
                  Black
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 레시피 순서-->
    <div>
      <p class="text-xl font-bold mt-3 border-b border-b-[#2e8b57]">레시피</p>
      <div>
        <!-- 레시피 순서 content -->
      </div>
    </div>













    <div class="mt-10 ">
      {% comment %} {% for review in reviews %}
        <div class="flex items-center justify-between">
          <div>
            <span>{{ review.user }}</span>
            <input type="text" class="reviewContent{{ review.pk }} border-0" value="{{ review.content }}" readonly>
          </div>
          <button id="dropdownDefaultButton" data-dropdown-toggle="dropdown" class="" type="button"><i class="bi bi-three-dots-vertical"></i></button>
          <div id="dropdown" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-20 dark:bg-gray-700">
            <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
              <li class="reviewUpdate{{ review.pk }}">
                <button onClick="reviewUpdateFunc({{ review.pk }})" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">수정</button>
              </li>
              <li>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">삭제</a>
              </li>
            </ul>
          </div>
          <div class="reviewUpdate{{ review.pk }}">
            <button type="button" onClick="reviewUpdateFunc({{ review.pk }})">수정</button>
          </div>
          <div class="reviewSubmit{{ review.pk }}" style="display: none;">
            <input type="button" value="submit" onClick="reviewSubmitFunc({{ review.pk }})">
            <input type="button" value="cancel" onClick="reviewUpdateCancel({{ review.pk }})">
          </div>
        </div>
        <hr>
      {% endfor %} {% endcomment %}
      
      <section id="reviews">
        {% for review in reviews %}
          <div id="review" class="grid grid-cols-8" data-csrftoken="{{ csrf_token }}" data-recipe-pk="{{ recipe.pk }}" data-review-pk="{{ review.pk }}"  data-update-url="{% url 'recipes:review_update' %}">
            <p>{{ review.user }}</p>
            <p id="review-content" class="col-span-5">{{ review.content|linebreaksbr }}</p>
            <input class="rounded p-0 focus:ring-0 hidden col-span-5" type="text" value="{{ review.content }}">
            <div id="submit-section" class="invisible">
              <span class="cursor-pointer">수정</span>
              <span class="cursor-pointer">취소</span>
            </div>
            <div class="flex">
              <button class="" id="dropdownDefaultButton" data-dropdown-toggle="dropdown-{{ review.pk }}" type="button"><i class="bi bi-three-dots-vertical"></i></button>
              <div id="dropdown-{{ review.pk }}" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-20 dark:bg-gray-700">
                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefaultButton">
                  {% comment %} <li>
                    <a class="block px-4 m-0 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">{{ review.pk }}</a>
                  </li> {% endcomment %}
                  <li>
                    <a class="block m-0 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white cursor-pointer">수정</a>
                  </li>
                  <li>
                    <a class="block m-0 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white cursor-pointer">삭제</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        {% endfor %}
      </section>

      <form action="{% url 'recipes:review_create' recipe.pk %}" method="POST">
        {% csrf_token %}
        {{ review_form.content|as_crispy_field }}
        <input type="submit">
      </form>
    </div>

  </section>
</div>



<script>
  const reviewUpdateFunc = (pk) => {
    let reviewUpdate = document.querySelector(`.reviewUpdate${pk}`)
    let reviewSubmit = document.querySelector(`.reviewSubmit${pk}`)
    let reviewContent = document.querySelector(`.reviewContent${pk}`)

    reviewUpdate.style.display = 'none'
    reviewSubmit.style.display = 'inline-block'
    reviewSubmit.style.display = 'inline-block'
    
    reviewContent.readOnly = false
  }

  const reviewSubmitFunc = (pk) => {
    let reviewUpdate = document.querySelector(`.reviewUpdate${pk}`)
    let reviewSubmit = document.querySelector(`.reviewSubmit${pk}`)
    let reviewContent = document.querySelector(`.reviewContent${pk}`)

    let param = {
      'pk': pk,
      'content': reviewContent.value
    }

    $.ajax({
      url: '{% url 'recipes:review_update' %}',
      type: 'POST',
      headers: {
        'X-CSRFTOKEN': '{{ csrf_token }}'
      },
      data: JSON.stringify(param),
      success:function(data) {
        reviewContent.value = data.content
        reviewContent.readOnly = true
        reviewSubmit.style.display = 'none'
        reviewUpdate.style.display = 'inline-block'
      },
      error: function() {
        alert('오류!')
      }
    })
  }

  const reviewUpdateCancel = (pk) => {
    let reviewUpdate = document.querySelector(`.reviewUpdate${pk}`)
    let reviewSubmit = document.querySelector(`.reviewSubmit${pk}`)
    let reviewContent = document.querySelector(`.reviewContent${pk}`)

    reviewUpdate.style.display = 'inline-block'
    reviewSubmit.style.display = 'none'
    reviewContent.readOnly = true
  }
</script>

<script src="{% static 'js/recipes/review.js' %}"></script>
{% endblock content %}